/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/f/library","sap/ui/core/Control","sap/m/Text","sap/f/Avatar","sap/ui/Device","sap/f/cards/DataProviderFactory","sap/ui/model/json/JSONModel","sap/f/cards/HeaderRenderer","sap/f/cards/IconFormatter","sap/f/cards/ActionEnablement","sap/base/strings/formatMessage"],function(t,e,a,i,r,s,n,o,p,d,l){"use strict";var h=t.AvatarShape;var u=e.extend("sap.f.cards.Header",{metadata:{library:"sap.f",interfaces:["sap.f.cards.IHeader"],properties:{title:{type:"string",defaultValue:""},subtitle:{type:"string",defaultValue:""},statusText:{type:"string",defaultValue:""},iconDisplayShape:{type:"sap.f.AvatarShape",defaultValue:h.Circle},iconSrc:{type:"sap.ui.core.URI",defaultValue:""},iconInitials:{type:"string",defaultValue:""}},aggregations:{_title:{type:"sap.m.Text",multiple:false,visibility:"hidden"},_subtitle:{type:"sap.m.Text",multiple:false,visibility:"hidden"},_avatar:{type:"sap.f.Avatar",multiple:false,visibility:"hidden"}},events:{press:{}}}});u.prototype.init=function(){this._aReadyPromises=[];this._bReady=false;this._awaitEvent("_dataReady");this._awaitEvent("_actionHeaderReady");Promise.all(this._aReadyPromises).then(function(){this._bReady=true;this.fireEvent("_ready")}.bind(this));this.setBusyIndicatorDelay(0)};u.prototype.exit=function(){this._oServiceManager=null;this._oDataProviderFactory=null;if(this._oDataProvider){this._oDataProvider.destroy();this._oDataProvider=null}};u.prototype._awaitEvent=function(t){this._aReadyPromises.push(new Promise(function(e){this.attachEventOnce(t,function(){e()})}.bind(this)))};u.prototype.isReady=function(){return this._bReady};u.prototype._getTitle=function(){var t=this.getAggregation("_title");if(!t){t=new a({maxLines:3}).addStyleClass("sapFCardTitle");this.setAggregation("_title",t)}return t};u.prototype._getSubtitle=function(){var t=this.getAggregation("_subtitle");if(!t){t=new a({maxLines:2}).addStyleClass("sapFCardSubtitle");this.setAggregation("_subtitle",t)}return t};u.prototype._getAvatar=function(){var t=this.getAggregation("_avatar");if(!t){t=(new i).addStyleClass("sapFCardIcon");this.setAggregation("_avatar",t)}return t};u.prototype.onBeforeRendering=function(){this._getTitle().setText(this.getTitle());this._getSubtitle().setText(this.getSubtitle());this._getAvatar().setDisplayShape(this.getIconDisplayShape());if(this.isInsideIntegrationCard()&&this.getIconSrc()){var t=this.getModel("parameters").getProperty("/appId");var e=this.getBindingInfo("iconSrc");if(e){e.formatter=function(e){return p.formatSrc(e,t)};this._getAvatar().bindProperty("src",e)}else{this._getAvatar().setSrc(p.formatSrc(this.getIconSrc(),t))}}else{this._getAvatar().setSrc(this.getIconSrc())}this._getAvatar().setInitials(this.getIconInitials())};u.prototype._getHeaderAccessibility=function(){var t=this._getTitle()?this._getTitle().getId():"",e=this._getSubtitle()?this._getSubtitle().getId():"",a=this._getAvatar()?this._getAvatar().getId():"";return t+" "+e+" "+a};u.prototype.onAfterRendering=function(){if(r.browser.msie){if(this.getTitle()){this._getTitle().clampText()}if(this.getSubtitle()){this._getSubtitle().clampText()}}};u.prototype.ontap=function(){this.firePress()};u.prototype.isInsideIntegrationCard=function(){var t=this.getParent();if(t&&t.isA("sap.ui.integration.widgets.Card")){return true}return false};u.create=function(t,e,a){var i={title:t.title,subtitle:t.subTitle};if(t.icon){i.iconSrc=t.icon.src;i.iconDisplayShape=t.icon.shape;i.iconInitials=t.icon.text}if(t.status&&typeof t.status.text==="string"){i.statusText=t.status.text}var r=new u(i);if(t.status&&t.status.text&&t.status.text.format){u._bindStatusText(t.status.text.format,r)}r.setServiceManager(e);r.setDataProviderFactory(a);r._setData(t.data);r._attachActions(t,r);return r};u._bindStatusText=function(t,e){if(t.parts&&t.translationKey&&t.parts.length===2){var a={parts:[t.translationKey,t.parts[0].toString(),t.parts[1].toString()],formatter:function(e,a,i){var r=a||t.parts[0];var s=i||t.parts[1];if(Array.isArray(a)){r=a.length}if(Array.isArray(i)){s=i.length}var n=parseFloat(r)||0;var o=parseFloat(s)||0;return l(e,[n,o])}};e.bindProperty("statusText",a)}};u.prototype.setServiceManager=function(t){this._oServiceManager=t;return this};u.prototype.setDataProviderFactory=function(t){this._oDataProviderFactory=t;return this};u.prototype._setData=function(t){var e="/";if(t&&t.path){e=t.path}this.bindObject(e);if(this._oDataProvider){this._oDataProvider.destroy()}this._oDataProvider=this._oDataProviderFactory.create(t,this._oServiceManager);if(this._oDataProvider){this.setBusy(true);this.setModel(new n);this._oDataProvider.attachDataChanged(function(t){this._updateModel(t.getParameter("data"));this.setBusy(false)}.bind(this));this._oDataProvider.attachError(function(t){this._handleError(t.getParameter("message"));this.setBusy(false)}.bind(this));this._oDataProvider.triggerDataUpdate().then(function(){this.fireEvent("_dataReady")}.bind(this))}else{this.fireEvent("_dataReady")}};u.prototype._updateModel=function(t){this.getModel().setData(t)};u.prototype._handleError=function(t){this.fireEvent("_error",{logMessage:t})};d.enrich(u);return u});