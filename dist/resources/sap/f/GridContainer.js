/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/Core","sap/ui/base/ManagedObjectObserver","sap/ui/core/ResizeHandler","sap/ui/core/delegate/ItemNavigation","sap/f/GridContainerRenderer","sap/ui/Device","sap/ui/layout/cssgrid/VirtualGrid","sap/f/GridContainerSettings","sap/base/strings/capitalize"],function(t,e,i,r,s,n,a,o,l,h){"use strict";var u=e.getConfiguration().getRTL();var g=16;function p(){return!a.browser.msie&&!(a.browser.edge&&a.browser.version<g)}function f(t){var e=t.getLayoutData();return e?e.getColumns():1}function d(t){var e=t.getLayoutData();return e?e.getActualRows():1}function c(t){var e=t.getLayoutData();return e?e.hasAutoHeight():true}var y=t.extend("sap.f.GridContainer",{metadata:{library:"sap.f",interfaces:["sap.f.dnd.IGridDroppable"],properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},containerQuery:{type:"boolean",group:"Behavior",defaultValue:false},snapToRow:{type:"boolean",group:"Appearance",defaultValue:false},allowDenseFill:{type:"boolean",group:"Appearance",defaultValue:false},inlineBlockLayout:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.core.Control",multiple:true,singularName:"item",dnd:true},layout:{type:"sap.f.GridContainerSettings",multiple:false},layoutXS:{type:"sap.f.GridContainerSettings",multiple:false},layoutS:{type:"sap.f.GridContainerSettings",multiple:false},layoutM:{type:"sap.f.GridContainerSettings",multiple:false},layoutL:{type:"sap.f.GridContainerSettings",multiple:false},layoutXL:{type:"sap.f.GridContainerSettings",multiple:false},_defaultLayout:{type:"sap.f.GridContainerSettings",multiple:false,visibility:"hidden"}},events:{layoutChange:{parameters:{layout:{type:"string"}}}},dnd:{draggable:false,droppable:true}}});y.prototype.bUseExtendedChangeDetection=true;y.prototype.getActiveLayoutSettings=function(){var t=this.getAggregation(this._sActiveLayout);if(!t&&this._sActiveLayout==="layoutXS"){t=this.getAggregation("layoutS")}if(!t){t=this.getAggregation("layout")||this.getAggregation("_defaultLayout")}return t};y.prototype._onBeforeItemRendering=function(){var t=this.getParent(),e=t._resizeListeners[this.getId()];if(e){r.deregister(e)}delete t._resizeListeners[this.getId()]};y.prototype._onAfterItemRendering=function(){var t=this.getParent();t._resizeListeners[this.getId()]=r.register(this,t._resizeItemHandler);t._setItemNavigationItems();if(!p()){t._scheduleIEPolyfill();return}t._applyItemAutoRows(this)};y.prototype._onItemChange=function(t){if(t.name!=="items"||!t.child){return}if(t.mutation==="insert"){t.child.addEventDelegate(this._itemDelegate,t.child)}else if(t.mutation==="remove"){t.child.removeEventDelegate(this._itemDelegate,t.child)}};y.prototype._deregisterResizeListeners=function(){var t,e;for(t in this._resizeListeners){e=this._resizeListeners[t];r.deregister(e)}delete this._resizeListeners;if(!this.getContainerQuery()){a.resize.detachHandler(this._resizeHandler)}};y.prototype._setItemNavigationItems=function(){if(!this._isRenderingFinished){return}};y.prototype._detectActiveLayout=function(){var t=this.getContainerQuery()&&this.getDomRef()?this.$().outerWidth():a.resize.width,e=a.media.getCurrentRange("GridContainerRangeSet",t),i="layout"+e.name,r=this.getActiveLayoutSettings(),s=false;if(this._sActiveLayout!==i){this.addStyleClass("sapFGridContainer"+h(i));if(this._sActiveLayout){this.removeStyleClass("sapFGridContainer"+h(this._sActiveLayout))}this._sActiveLayout=i;s=r!==this.getActiveLayoutSettings();this.fireLayoutChange({layout:this._sActiveLayout})}return s};y.prototype._getActiveGridStyles=function(){var t=this.getActiveLayoutSettings(),e=t.getColumns()||"auto-fill",i=t.getColumnSize(),r=t.getMinColumnSize(),s=t.getMaxColumnSize(),n={"grid-gap":t.getGap()};if(r&&s){n["grid-template-columns"]="repeat("+e+", minmax("+r+", "+s+"))"}else{n["grid-template-columns"]="repeat("+e+", "+i+")"}if(this.getInlineBlockLayout()){n["grid-auto-rows"]="min-content"}else{n["grid-auto-rows"]=t.getRowSize()}return n};y.prototype.init=function(){this.setAggregation("_defaultLayout",new l);this._initRangeSet();this._resizeListeners={};this._itemDelegate={onBeforeRendering:this._onBeforeItemRendering,onAfterRendering:this._onAfterItemRendering};this._itemsObserver=new i(this._onItemChange.bind(this));this._itemsObserver.observe(this,{aggregations:["items"]});this._resizeHandler=this._resize.bind(this);if(!this.getContainerQuery()){a.resize.attachHandler(this._resizeHandler)}this._resizeItemHandler=this._resizeItem.bind(this);this._itemNavigation=(new s).setCycling(false);this._itemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"]});this.addDelegate(this._itemNavigation);if(!p()){this._attachDndPolyfill()}};y.prototype.insertItem=function(t,i){if(!this.getDomRef()||!p()){return this.insertAggregation("items",t,i)}var r=e.createRenderManager(),s=this._createItemWrapper(t),n=this._getItemAt(i),a=this.getDomRef();if(n){a.insertBefore(s,n.getDomRef().parentElement)}else{a.appendChild(s)}this.insertAggregation("items",t,i,true);r.render(t,s);r.destroy();return this};y.prototype.removeItem=function(t){var e=this.removeAggregation("items",t,true),i=this.getDomRef(),r=e.getDomRef();if(!i||!r||!p()){this.invalidate();return e}i.removeChild(r.parentElement);return e};y.prototype.onBeforeRendering=function(){this._detectActiveLayout();var t=this._resizeListeners[this.getId()];if(t){r.deregister(t)}this._isRenderingFinished=false};y.prototype.onAfterRendering=function(){this._resizeListeners[this.getId()]=r.register(this.getDomRef(),this._resizeHandler);this._isRenderingFinished=true;this._setItemNavigationItems();this._applyLayout(true)};y.prototype.exit=function(){this._deregisterResizeListeners();if(this._itemsObserver){this._itemsObserver.disconnect();delete this._itemsObserver}if(this._itemNavigation){this.removeDelegate(this._itemNavigation);this._itemNavigation.destroy();delete this._itemNavigation}if(!p()){this._detachDndPolyfill()}};y.prototype._initRangeSet=function(){if(!a.media.hasRangeSet("GridContainerRangeSet")){a.media.initRangeSet("GridContainerRangeSet",[375,600,1024,1440],"px",["XS","S","M","L","XL"])}};y.prototype._resize=function(){if(!this._isWidthChanged()){return}var t=this._detectActiveLayout();this._applyLayout(t)};y.prototype._isWidthChanged=function(){var t=this.getDomRef()?this.$().outerWidth():0,e=a.resize.width;if(this._lastGridWidth===t&&this._lastViewportWidth===e){return false}this._lastGridWidth=t;this._lastViewportWidth=e;return true};y.prototype._resizeItem=function(t){if(!p()){this._scheduleIEPolyfill();return}this._applyItemAutoRows(t.control)};y.prototype._applyLayout=function(t){if(!this._isRenderingFinished){return}if(!p()){this._scheduleIEPolyfill(t);return}if(t){this.$().css(this._getActiveGridStyles());this.getItems().forEach(this._applyItemAutoRows.bind(this))}this._enforceMaxColumns()};y.prototype._applyItemAutoRows=function(t){if(!this._isRenderingFinished){return}if(this.getInlineBlockLayout()){return}if(c(t)){var e=t.$(),i=this.getActiveLayoutSettings(),r=i.calculateRowsForItem(e.height());if(!r){return}e.parent().css({"grid-row":"span "+Math.max(r,d(t))})}};y.prototype._enforceMaxColumns=function(){var t=this.getActiveLayoutSettings(),e=t.getComputedColumnsCount(this.$().innerWidth());if(!e){return}this.getItems().forEach(function(t){t.$().parent().css("grid-column","span "+Math.min(f(t),e))})};y.prototype._getItemAt=function(t){var e=this.getItems(),i;if(t<0){t=0}if(e.length&&e[t]){i=e[t]}return i};y.prototype._createItemWrapper=function(t){var e=n.getStylesForItemWrapper(t,this),i=e.styles,r=e.classes,s=document.createElement("div");i.forEach(function(t,e){s.style.setProperty(e,t)});r.forEach(function(t){s.classList.add(t)});return s};y.prototype._scheduleIEPolyfill=function(t){if(this._iPolyfillCallId){clearTimeout(this._iPolyfillCallId)}if(t){this._applyIEPolyfillLayout();return}this._iPolyfillCallId=setTimeout(this._applyIEPolyfillLayout.bind(this),0)};y.prototype._applyIEPolyfillLayout=function(){if(!this._isRenderingFinished){return}var t=this.$(),e=t.innerWidth(),i=this.getActiveLayoutSettings(),r=i.getColumnSizeInPx(),s=i.getRowSizeInPx(),n=i.getGapInPx(),a=i.getComputedColumnsCount(e),l=parseInt(t.css("padding-top").replace("px","")),h=parseInt(t.css("padding-left").replace("px","")),g=this.getItems();if(i.getMinColumnSize()){return}if(!r||!s){return}if(!g.length){return}var p=new o;p.init({numberOfCols:Math.max(1,a),cellWidth:r,cellHeight:s,unitOfMeasure:"px",gapSize:n,topOffset:l?l:0,leftOffset:h?h:0,allowDenseFill:this.getAllowDenseFill(),rtl:u,width:e});var y,m,_,v,I,A,C=[];var R=function(t){p.fitElement(t+"",i.calculateColumnsForItem(Math.round(this._polyfillDropIndicator.width)),i.calculateRowsForItem(Math.round(this._polyfillDropIndicator.height)));C.push({id:t+"",domRef:this._polyfillDropIndicator.domRef})}.bind(this);for(y=0,m=0;y<g.length;y++){if(this._polyfillDropIndicator&&this._polyfillDropIndicator.insertAt===y){R(m);m++}_=g[y];v=_.$();if(!v.is(":visible")){continue}I=f(_);if(c(_)){A=i.calculateRowsForItem(v.height())}else{A=d(_)}p.fitElement(m+"",I,A);C.push({id:m+"",domRef:v.parent()});m++}if(this._polyfillDropIndicator&&this._polyfillDropIndicator.insertAt>=g.length){R(g.length)}p.calculatePositions();C.forEach(function(t){var e=p.getItems()[t.id];t.domRef.css({position:"absolute",top:e.top,left:e.left,width:e.width,height:e.height})});t.css("height",p.getHeight()+"px")};y.prototype._polyfillAfterDragOver=function(t){var e=t.getParameter("indicator");this._polyfillDropIndicator={width:t.getParameter("width"),height:t.getParameter("height"),domRef:e,insertAt:e.index()};this._scheduleIEPolyfill()};y.prototype._polyfillAfterDragEnd=function(t){this._polyfillDropIndicator=null};y.prototype._attachDndPolyfill=function(){this.attachEvent("_gridPolyfillAfterDragOver",this._polyfillAfterDragOver,this);this.attachEvent("_gridPolyfillAfterDragEnd",this._polyfillAfterDragEnd,this)};y.prototype._detachDndPolyfill=function(){this.detachEvent("_gridPolyfillAfterDragOver",this._polyfillAfterDragOver,this);this.detachEvent("_gridPolyfillAfterDragEnd",this._polyfillAfterDragEnd,this)};return y});