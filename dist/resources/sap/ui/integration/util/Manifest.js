/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Manifest","sap/base/util/deepClone","sap/base/util/merge","sap/base/Log"],function(e,t,n,r,i){"use strict";var s="/{SECTION}/configuration/parameters",o="/{SECTION}";var a=e.extend("sap.ui.integration.util.Manifest",{constructor:function(n,r,a){e.call(this);this.PARAMETERS=s.replace("{SECTION}",n);this.CONFIGURATION=o.replace("{SECTION}",n);if(r){var f={};f.process=false;if(a){f.baseUrl=a;this._sBaseUrl=a}else{i.warning("If no base URL is provided when the manifest is an object static resources cannot be loaded.")}this._oManifest=new t(r,f);this.oJson=this._oManifest.getRawJson()}}});a.prototype.getJson=function(){return this._unfreeze(this.oJson)};a.prototype.get=function(e){return this._unfreeze(l(this.oJson,e))};a.prototype.getUrl=function(){return this._oManifest.resolveUri("./","manifest")};a.prototype.getResourceBundle=function(){return this.oResourceBundle};a.prototype._unfreeze=function(e){if(typeof e==="object"){return JSON.parse(JSON.stringify(e))}return e};a.prototype.destroy=function(){this.oJson=null;this.oResourceBundle=null;if(this._oManifest){this._oManifest.destroy()}};a.prototype.load=function(e){if(!e||!e.manifestUrl){if(this._sBaseUrl&&this._oManifest){return this.loadI18n().then(function(){this.processManifest()}.bind(this))}else{return new Promise(function(e,t){t("Cannot load manifest.")})}}return t.load({manifestUrl:e.manifestUrl,async:true}).then(function(e){this._oManifest=e;this.oJson=this._oManifest.getRawJson();return this.loadI18n().then(function(){this.processManifest()}.bind(this))}.bind(this))};a.prototype.loadI18n=function(){return this._oManifest._loadI18n(true).then(function(e){this.oResourceBundle=e}.bind(this))};a.prototype.processManifest=function(e){var t=0,n=15,r=jQuery.extend(true,{},this._oManifest.getRawJson());h(r,this.oResourceBundle,t,n,e);f(r);this.oJson=r};function f(e){if(e&&typeof e==="object"&&!Object.isFrozen(e)){Object.freeze(e);for(var t in e){if(e.hasOwnProperty(t)){f(e[t])}}}}function u(e){return typeof e==="string"&&e.indexOf("{{")===0&&e.indexOf("}}")===e.length-2}function c(e){return typeof e==="string"&&e.indexOf("{{parameters.")>-1}function p(e,t){var n=(new Date).toISOString();var r=e.replace("{{parameters.NOW_ISO}}",n);r=r.replace("{{parameters.TODAY_ISO}}",n.slice(0,10));if(t){for(var i in t){r=r.replace("{{parameters."+i+"}}",t[i].value)}}return r}function h(e,t,n,r,i){if(n===r){return}if(Array.isArray(e)){e.forEach(function(s,o,a){if(typeof s==="object"){h(s,t,n+1,r,i)}else if(c(s,e,i)){a[o]=p(s,i)}else if(u(s)&&t){a[o]=t.getText(s.substring(2,s.length-2))}},this)}else{for(var s in e){if(typeof e[s]==="object"){h(e[s],t,n+1,r,i)}else if(c(e[s],e,i)){e[s]=p(e[s],i)}else if(u(e[s])&&t){e[s]=t.getText(e[s].substring(2,e[s].length-2))}}}}function l(e,t){if(e&&t&&typeof t==="string"&&t[0]==="/"){var n=t.substring(1).split("/"),r;for(var i=0,s=n.length;i<s;i++){r=n[i];e=e.hasOwnProperty(r)?e[r]:undefined;if(e===null||typeof e!=="object"){if(i+1<s&&e!==undefined){e=undefined}break}}return e}return e&&e[t]}a.prototype.processParameters=function(e){if(!this._oManifest){return}var t=this.get(this.PARAMETERS);if(e&&!t){i.error("If parameters property is set, parameters should be described in the manifest");return}var n=this._syncParameters(e,t);this.processManifest(n)};a.prototype._mergeConfiguration=function(e){if(!this._oManifest){return}if(!e){return}var t=this.get(this.CONFIGURATION),i=n(this.oJson,30,30);i[this.CONFIGURATION.substring(1)]=r({},t,e);this._oManifest._oManifest=i;this.oJson=i};a.prototype._syncParameters=function(e,t){if(!e){return t}var r=n(t,20,20),i=Object.getOwnPropertyNames(e),s=Object.getOwnPropertyNames(r);for(var o=0;o<s.length;o++){for(var a=0;a<i.length;a++){if(s[o]===i[a]){r[s[o]].value=e[i[a]]}}}return r};return a},true);