/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/model/resource/ResourceModel","./utils/ObjectBinding","sap/base/util/ObjectPath","sap/base/util/merge","sap/base/util/deepClone","sap/ui/model/json/JSONModel","sap/base/i18n/ResourceBundle","sap/ui/model/BindingMode"],function(t,e,o,r,i,n,s,a,d){"use strict";var p=t.extend("sap.ui.integration.designtime.controls.BaseEditor",{metadata:{properties:{config:{type:"object"},json:{type:"object",multiple:false},_defaultConfig:{type:"object",visibility:"hidden",defaultValue:{}}},aggregations:{_propertyEditors:{type:"sap.ui.core.Control",visibility:"hidden"}},events:{jsonChanged:{parameters:{json:{type:"object"}}},propertyEditorsReady:{parameters:{propertyEditors:{type:"array"}}}}},init:function(){this.setConfig({})},exit:function(){this._cleanup()},renderer:function(t,e){t.write("<div");t.writeElementData(e);t.addClass("sapUiIntegrationEditor");t.writeClasses();t.writeStyles();t.write(">");e.getPropertyEditors().forEach(function(e){e.addStyleClass("sapUiSmallMargin");t.renderControl(e)});t.write("</div>")},setJson:function(t){if(typeof t==="string"){t=JSON.parse(t)}var e=this.setProperty("json",t,false);this._initialize();return e},addDefaultConfig:function(t){return this.setProperty("_defaultConfig",this._mergeConfig(this.getProperty("_defaultConfig"),t))},setConfig:function(t){return this._setConfig(this._mergeConfig(this.getProperty("_defaultConfig"),t))},addConfig:function(t){return this._setConfig(this._mergeConfig(this.getConfig(),t))},getPropertyEditor:function(t){return this._mPropertyEditors[t]},getPropertyEditors:function(t){var e=function(t,e){return t.getPropertyInfo().tags&&t.getPropertyInfo().tags.indexOf(e)!==-1};if(!t){return this.getAggregation("_propertyEditors")}else if(typeof t==="string"){return this.getPropertyEditors().filter(function(o){return e(o,t)})}else if(Array.isArray(t)){return this.getPropertyEditors().filter(function(o){return t.every(function(t){return e(o,t)})})}else{return[]}}});p.prototype._mergeConfig=function(t,e){var o=n(t);i(o,e);o.i18n=[].concat(t.i18n||[],e.i18n||[]);return o};p.prototype._setConfig=function(t){var e=this.setProperty("config",t,false);this._initialize();return e};p.prototype._cleanup=function(t){if(this._oContextModel){this._oContextModel.destroy();delete this._oContextModel}if(this._oPropertyModel){this._oPropertyModel.destroy();delete this._oPropertyModel}if(this._oI18nModel){this._oI18nModel.destroy();delete this._oI18nModel}if(this._oPropertyObjectBinding){this._oPropertyObjectBinding.destroy();delete this._oPropertyObjectBinding}this._mPropertyEditors={};this.destroyAggregation("_propertyEditors")};p.prototype._initialize=function(){this._cleanup();if(this.getConfig()&&this.getConfig().properties){this._createModels();this._createEditors()}};p.prototype._createModels=function(){this._createContextModel();this._createPropertyModel();this._createI18nModel()};p.prototype._createContextModel=function(){var t=this.getJson();var e=this.getConfig();if(e.context){t=r.get(e.context.split("/"),t)}this._oContextModel=new s(t);this._oContextModel.setDefaultBindingMode(d.OneWay)};p.prototype._createPropertyModel=function(){var t=this.getConfig();this._oPropertyModel=new s(t.properties);this._oPropertyModel.setDefaultBindingMode(d.OneWay);this._oPropertyObjectBinding=new o(t.properties,this._oPropertyModel,"properties");Object.keys(t.properties).forEach(function(e){var o=t.properties[e];if(o.path){this._syncPropertyValue(o)}}.bind(this))};p.prototype._createI18nModel=function(){var t=this.getConfig();t.i18n.forEach(function(t){a.create({url:sap.ui.require.toUrl(t),async:true}).then(function(t){if(!this._oI18nModel){this._oI18nModel=new e({bundle:t});this.setModel(this._oI18nModel,"i18n");this._oI18nModel.setDefaultBindingMode(d.OneWay)}else{this._oI18nModel.enhance(t)}}.bind(this))}.bind(this))};p.prototype._syncPropertyValue=function(t){var e=this._oContextModel.getData();if(e&&t.path){t.value=r.get(t.path.split("/"),e)}if(typeof t.value==="undefined"){t.value=t.defaultValue}};p.prototype._createEditors=function(){var t=this.getConfig();var e=Object.keys(t.propertyEditors);var o=e.map(function(e){return t.propertyEditors[e]});var r={};this.__createEditorsCallCount=(this.__createEditorsCallCount||0)+1;var i=this.__createEditorsCallCount;sap.ui.require(o,function(){if(this.__createEditorsCallCount===i){Array.from(arguments).forEach(function(t,o){r[e[o]]=t});Object.keys(t.properties).forEach(function(t){var e=this._oPropertyModel.getContext("/"+t);var o=r[e.getObject().type];if(o){this._mPropertyEditors[t]=this._createPropertyEditor(o,e);this.addAggregation("_propertyEditors",this._mPropertyEditors[t])}}.bind(this));this.firePropertyEditorsReady({propertyEditors:this.getPropertyEditors()})}}.bind(this))};p.prototype._createPropertyEditor=function(t,e){var o=new t({visible:typeof e.getObject().visible!==undefined?e.getObject().visible:true});o.setModel(this._oPropertyModel);o.setBindingContext(e);o.setModel(this._oContextModel,"context");o.attachPropertyChanged(this._onPropertyChanged.bind(this));return o};p.prototype._onPropertyChanged=function(t){var e=t.getParameter("path");this._oContextModel.setProperty("/"+e,t.getParameter("value"));this._updatePropertyModel(e);this.fireJsonChanged({json:n(this.getJson())})};p.prototype._updatePropertyModel=function(t){var e=this._oPropertyModel.getData();Object.keys(e).filter(function(o){return e[o].path===t}).forEach(function(t){this._syncPropertyValue(e[t])}.bind(this));this._oPropertyModel.checkUpdate()};return p});