/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/core/Control","sap/ui/integration/util/Manifest","sap/ui/integration/util/ServiceManager","sap/base/Log","sap/f/cards/DataProviderFactory","sap/f/cards/NumericHeader","sap/f/cards/Header","sap/f/cards/BaseContent","sap/m/HBox","sap/m/VBox","sap/ui/core/Icon","sap/m/Text","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/base/util/LoaderExtensions","sap/f/CardRenderer","sap/f/library","sap/ui/integration/library"],function(t,e,a,i,r,s,n,o,d,h,p,f,y,c,u,_,g,l,v,C){"use strict";var M={TYPE:"/sap.card/type",DATA:"/sap.card/data",HEADER:"/sap.card/header",HEADER_POSITION:"/sap.card/headerPosition",CONTENT:"/sap.card/content",SERVICES:"/sap.ui5/services",APP_TYPE:"/sap.app/type",PARAMS:"/sap.card/configuration/parameters"};var m=v.cards.HeaderPosition;var P=C.CardDataMode;var E=a.extend("sap.ui.integration.widgets.Card",{metadata:{library:"sap.ui.integration",interfaces:["sap.f.ICard"],properties:{manifest:{type:"any",defaultValue:""},parameters:{type:"object",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"},dataMode:{type:"sap.ui.integration.CardDataMode",group:"Behavior",defaultValue:P.Active},baseUrl:{type:"sap.ui.core.URI",defaultValue:null}},aggregations:{_header:{type:"sap.f.cards.IHeader",multiple:false,visibility:"hidden"},_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{action:{parameters:{actionSource:{type:"sap.ui.core.Control"},manifestParameters:{type:"object"},type:{type:"sap.ui.integration.CardActionType"}}}},associations:{hostConfigurationId:{}}},renderer:l});E.prototype.init=function(){this.setModel(new u,"parameters");this.setBusyIndicatorDelay(0)};E.prototype._initReadyState=function(){this._aReadyPromises=[];this._awaitEvent("_headerReady");this._awaitEvent("_contentReady");this._awaitEvent("_cardReady");this._oReadyPromise=Promise.all(this._aReadyPromises).then(function(){this._bReady=true;this.fireEvent("_ready")}.bind(this))};E.prototype._clearReadyState=function(){this._bReady=false;this._aReadyPromises=[];this._oReadyPromise=null};E.prototype.onBeforeRendering=function(){var t=this.getHostConfigurationId();if(this.getDataMode()!==P.Active){return}if(t){this.addStyleClass(t.replace(/-/g,"_"))}if(this._bApplyManifest){this._bApplyManifest=false;var e=this.getManifest();this._clearReadyState();this._initReadyState();if(!e){this.destroyManifest()}else{this.createManifest(e,this.getBaseUrl())}}};E.prototype.setManifest=function(t){this.setProperty("manifest",t);this._bApplyManifest=true;return this};E.prototype.setParameters=function(t){this.setProperty("parameters",t);this._bApplyManifest=true;return this};E.prototype.createManifest=function(t,e){var a={};if(typeof t==="string"){a.manifestUrl=t;t=null}this.setBusy(true);this._oCardManifest=new i("sap.card",t,e);this._oCardManifest.load(a).then(this._applyManifest.bind(this)).catch(this._applyManifest.bind(this))};E.prototype._applyManifest=function(){var t=this.getParameters();this._registerManifestModulePath();if(this._oCardManifest&&this._oCardManifest.getResourceBundle()){var a=new _({bundle:this._oCardManifest.getResourceBundle()});a.enhance(e.getLibraryResourceBundle("sap.ui.integration"));this.setModel(a,"i18n")}this._oCardManifest.processParameters(t);this._applyManifestSettings()};E.prototype._awaitEvent=function(t){this._aReadyPromises.push(new Promise(function(e){this.attachEventOnce(t,function(){e()})}.bind(this)))};E.prototype.isReady=function(){return this._bReady};E.prototype.refresh=function(){if(this.getDataMode()===P.Active){this._clearReadyState();this._initReadyState();this.destroyManifest();this._bApplyManifest=true;this.invalidate()}};E.prototype.exit=function(){this.destroyManifest()};E.prototype.destroyManifest=function(){if(this._oCardManifest){this._oCardManifest.destroy();this._oCardManifest=null}if(this._oServiceManager){this._oServiceManager.destroy();this._oServiceManager=null}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null;this._oDataProvider=null}if(this._oTemporaryContent){this._oTemporaryContent.destroy();this._oTemporaryContent=null}this.destroyAggregation("_header");this.destroyAggregation("_content");this._aReadyPromises=null};E.prototype._registerManifestModulePath=function(){if(!this._oCardManifest){return}var t=this._oCardManifest.get("/sap.app/id");if(t){g.registerResourcePath(t.replace(/\./g,"/"),this._oCardManifest.getUrl());this.getModel("parameters").setProperty("/appId",t)}else{s.error("Card sap.app/id entry in the manifest is mandatory")}};E.prototype.getManifest=function(){var e=this.getProperty("manifest");if(e&&typeof e==="object"){return t.extend(true,{},e)}return e};E.prototype.getParameters=function(){var e=this.getProperty("parameters");if(e&&typeof e==="object"){return t.extend(true,{},e)}return e};E.prototype._applyManifestSettings=function(){var t=this._oCardManifest.get(M.APP_TYPE);if(t&&t!=="card"){s.error("sap.app/type entry in manifest is not 'card'")}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy()}this._oDataProviderFactory=new n;this._applyServiceManifestSettings();this._applyDataManifestSettings();this._applyHeaderManifestSettings();this._applyContentManifestSettings()};E.prototype._applyDataManifestSettings=function(){var t=this._oCardManifest.get(M.DATA);if(!t){this.fireEvent("_cardReady");return}if(this._oDataProvider){this._oDataProvider.destroy()}this._oDataProvider=this._oDataProviderFactory.create(t,this._oServiceManager);if(this._oDataProvider){this.setModel(new u);this._oDataProvider.attachDataChanged(function(t){this.getModel().setData(t.getParameter("data"))}.bind(this));this._oDataProvider.attachError(function(t){this._handleError("Data service unavailable. "+t.getParameter("message"))}.bind(this));this._oDataProvider.triggerDataUpdate().then(function(){this.fireEvent("_cardReady")}.bind(this))}};E.prototype._applyServiceManifestSettings=function(){var t=this._oCardManifest.get(M.SERVICES);if(!t){return}if(!this._oServiceManager){this._oServiceManager=new r(t,this)}};E.prototype.getCardHeader=function(){return this.getAggregation("_header")};E.prototype.getCardHeaderPosition=function(){if(!this._oCardManifest){return"Top"}return this._oCardManifest.get(M.HEADER_POSITION)||m.Top};E.prototype.getCardContent=function(){return this.getAggregation("_content")};E.prototype._applyHeaderManifestSettings=function(){var t=this._oCardManifest.get(M.HEADER);if(!t){this.fireEvent("_headerReady");return}var e=d;if(t.type==="Numeric"){e=o}this._setCardHeader(e)};E.prototype._applyContentManifestSettings=function(){var t=this._oCardManifest.get(M.TYPE),e=t&&t.toLowerCase()==="component",a=this._oCardManifest.get(M.CONTENT),i=!!a;if(i&&!t){s.error("Card type property is mandatory!");this.fireEvent("_contentReady");return}if(!i&&!e){this.setBusy(false);this.fireEvent("_contentReady");return}if(!a&&e){a=this._oCardManifest.getJson()}this._setTemporaryContent();h.create(t,a,this._oServiceManager,this._oDataProviderFactory).then(function(t){this._setCardContent(t)}.bind(this)).catch(function(t){this._handleError(t)}.bind(this)).finally(function(){this.setBusy(false)}.bind(this))};E.prototype._setCardHeader=function(t){var e=this._oCardManifest.get(M.HEADER),a=t.create(e,this._oServiceManager,this._oDataProviderFactory);a.attachEvent("action",function(t){this.fireEvent("action",{manifestParameters:t.getParameter("manifestParameters"),actionSource:t.getParameter("actionSource"),type:t.getParameter("type")})}.bind(this));var i=this.getAggregation("_header");if(i){i.destroy()}this.setAggregation("_header",a);if(a.isReady()){this.fireEvent("_headerReady")}else{a.attachEvent("_ready",function(){this.fireEvent("_headerReady")}.bind(this))}};E.prototype._fireReady=function(t,e){if(t.isReady()){this.fireEvent(e)}else{t.attachEvent("_ready",function(){this.fireEvent(e);this.setBusy(false)}.bind(this))}};E.prototype.onAfterRendering=function(){var t;if(this._oCardManifest&&this._oCardManifest.get(M.TYPE)){t=this._oCardManifest.get(M.TYPE).toLowerCase()}if(t==="analytical"){this.$().addClass("sapFCardAnalytical")}};E.prototype._setCardContent=function(t){t.attachEvent("action",function(t){this.fireEvent("action",{actionSource:t.getParameter("actionSource"),manifestParameters:t.getParameter("manifestParameters"),type:t.getParameter("type")})}.bind(this));t.attachEvent("_error",function(t){this._handleError(t.getParameter("logMessage"),t.getParameter("displayMessage"))}.bind(this));t.setBusyIndicatorDelay(0);var e=this.getAggregation("_content");if(e&&e!==this._oTemporaryContent){e.destroy()}this.setAggregation("_content",t);if(t.isReady()){this.fireEvent("_contentReady")}else{t.attachEvent("_ready",function(){this.fireEvent("_contentReady")}.bind(this))}};E.prototype._setTemporaryContent=function(){var t=this._getTemporaryContent(),e=this.getAggregation("_content");if(e&&e!==t){e.destroy()}this.setAggregation("_content",t)};E.prototype._handleError=function(t,e){s.error(t);this.setBusy(false);this.fireEvent("_error",{message:t});var a="Unable to load the data.",i=e||a,r=this._getTemporaryContent(),n=this.getAggregation("_content");var o=new f({justifyContent:"Center",alignItems:"Center",items:[new y({src:"sap-icon://message-error",size:"1rem"}).addStyleClass("sapUiTinyMargin"),new c({text:i})]});if(n&&n!==r){n.destroy();this.fireEvent("_contentReady")}r.setBusy(false);r.addItem(o);this.setAggregation("_content",r)};E.prototype._getTemporaryContent=function(){if(!this._oTemporaryContent){this._oTemporaryContent=new p({height:"100%",justifyContent:"Center",busyIndicatorDelay:0,busy:true});this._oTemporaryContent.addStyleClass("sapFCardContentBusy");this._oTemporaryContent.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return}var t=this._oCardManifest.get(M.TYPE)+"Content",e=this._oCardManifest.get(M.CONTENT),a=h.getMinHeight(t,e);if(this.getHeight()==="auto"){this._oTemporaryContent.$().css({"min-height":a})}}},this)}this._oTemporaryContent.destroyItems();return this._oTemporaryContent};E.prototype.setDataMode=function(t){if(this._oDataProviderFactory&&t===P.Inactive){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null}this.setProperty("dataMode",t,true);if(this.getProperty("dataMode")===P.Active){this.refresh()}return this};return E});