/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/core/Control","sap/ui/integration/util/Manifest","sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/integration/WidgetRenderer","sap/ui/integration/library","sap/base/util/LoaderExtensions","sap/ui/core/ComponentContainer"],function(t,e,i,n,s,r,a,o,p,f,u){"use strict";var g={APP_TYPE:"/sap.app/type",PARAMS:"/sap.widget/configuration/parameters"};var d=i.extend("sap.ui.integration.Widget",{metadata:{library:"sap.ui.integration",properties:{manifest:{type:"any",defaultValue:""},parameters:{type:"object",defaultValue:null},configuration:{type:"object"},baseUrl:{type:"string",defaultValue:""}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{action:{parameters:{actionSource:{type:"sap.ui.core.Control"},manifestParameters:{type:"object"}}}}},renderer:o});d.prototype.init=function(){this.setBusyIndicatorDelay(0)};d.prototype.onBeforeRendering=function(){if(this._bApplyManifest){this._bApplyManifest=false;var t=this.getManifest();if(!t){this.destroyManifest()}else{this.createManifest(t,this.getBaseUrl())}}};d.prototype.exit=function(){this.destroyManifest()};d.prototype.destroyManifest=function(){if(this._oWidgetManifest){this._oWidgetManifest.destroy();this._oWidgetManifest=null}this.destroyAggregation("_content")};d.prototype.setManifest=function(t){this.setProperty("manifest",t);this._bApplyManifest=true;return this};d.prototype.setParameters=function(t){this.setProperty("parameters",t);this._bApplyManifest=true;return this};d.prototype.getManifest=function(){var e=this.getProperty("manifest");if(e&&typeof e==="object"){return t.extend(true,{},e)}return e};d.prototype.createManifest=function(t,e){var i={};if(typeof t==="string"){i.manifestUrl=t;t=null}this.setBusy(true);this._oWidgetManifest=new n("sap.widget",t,e);this._oWidgetManifest.load(i).then(this._applyManifest.bind(this)).catch(this._applyManifest.bind(this))};d.prototype.setConfiguration=function(t){this._bApplyManifest=true;this.setBusy(true);this.setProperty("configuration",t);return this};d.prototype.getParameters=function(){var e=this.getProperty("parameters");if(e&&typeof e==="object"){return t.extend(true,{},e)}return e};d.prototype._applyManifest=function(){var t=this.getParameters(),e=this._oWidgetManifest.get(g.APP_TYPE),i=this.getConfiguration();if(e&&e!=="widget"){s.error("sap.app/type entry in manifest is not 'widget'")}this._oWidgetManifest._mergeConfiguration(i);this._createComponent(this._oWidgetManifest.getJson());this._registerManifestModulePath();this._oWidgetManifest.processParameters(t)};d.prototype._registerManifestModulePath=function(){if(!this._oWidgetManifest){return}var t=this._oWidgetManifest.get("/sap.app/id");if(t){f.registerResourcePath(t.replace(/\./g,"/"),this._oWidgetManifest.getUrl())}else{s.error("Widget sap.app/id entry in the manifest is mandatory")}};d.prototype._createComponent=function(t){var e=new u({manifest:t,async:true,componentCreated:function(t){var e=t.getParameter("component");this.setBusy(false);e.attachEvent("action",function(t){this.fireEvent("action",{actionSource:t.getParameter("actionSource"),manifestParameters:t.getParameter("manifestParameters")})}.bind(this))}.bind(this),componentFailed:function(t){this.setBusy(false);s.error(t.getParameter("reason"))}});this.setAggregation("_content",e)};d.prototype.loadDesigntime=function(){if(!this._oWidgetManifest){return Promise.reject("Manifest not yet available")}var t=this._oWidgetManifest.get("/sap.app/id");if(!t){return Promise.reject("App id not maintained")}var e=t.replace(/\./g,"/");return new Promise(function(t,i){var n=e+"/"+(this._oWidgetManifest.get("/sap.widget/designtime")||"designtime/Widget.designtime");if(n){sap.ui.require([n,"sap/base/util/deepClone"],function(e,i){t({configuration:i(this._oWidgetManifest.get("/sap.widget"),30),designtime:e,manifest:i(this._oWidgetManifest.oJson,30)})}.bind(this),function(){i({error:n+" not found"})})}else{i()}}.bind(this))};return d});